<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>OlÃ¡, {{ nomeUsuario }}!</h1>
    <p>Este Ã© o seu plano para atingir o objetivo: <strong>{{ objetivo }}</strong></p>
  </header>

  <main class="dashboard-grid">
    <div class="card calorias-card">
      <h3>Sua Meta DiÃ¡ria</h3>
      <div class="calorias-valor">{{ caloriasMeta }}</div>
      <div class="calorias-label">kcal</div>
      <div class="progresso-wrapper">
        <div class="progress-bar-container">
          <div 
            class="progress-bar" 
            [style.width.%]="calcularPercentual(caloriasConsumidas, caloriasMeta)"
            [style.background]="getCorProgressoCalorias(calcularPercentual(caloriasConsumidas, caloriasMeta))">
          </div>
        </div>
        <span class="progresso-texto-calorias">{{ caloriasConsumidas | number:'1.0-0' }} / {{ caloriasMeta }} kcal consumidas</span>
      </div>
    </div>

    <div class="card macros-card">
      <h3>DistribuiÃ§Ã£o de Macros (Metas)</h3>
      <div class="macros-grid">
        <div class="macro-item">
          <div class="macro-header">
            <span class="macro-label" [class.meta-atingida]="proteinasConsumidas >= proteinasMeta && proteinasMeta > 0">ProteÃ­nas</span>
            <span class="macro-valor" [class.meta-atingida]="proteinasConsumidas >= proteinasMeta && proteinasMeta > 0">{{ proteinasMeta }}g</span>
          </div>
          <div class="macro-progress-wrapper">
            <div class="macro-progress-bar-container">
              <div 
                class="macro-progress-bar macro-progress-proteinas" 
                [style.width.%]="calcularPercentual(proteinasConsumidas, proteinasMeta)">
              </div>
            </div>
            <span class="macro-progress-text" [class.meta-atingida]="proteinasConsumidas >= proteinasMeta && proteinasMeta > 0">{{ proteinasConsumidas | number:'1.0-0' }}g / {{ proteinasMeta }}g</span>
          </div>
          <div class="meta-atingida-alert" *ngIf="proteinasConsumidas >= proteinasMeta && proteinasMeta > 0">
            âœ… Meta de proteÃ­nas atingida!
          </div>
        </div>

        <div class="macro-item">
          <div class="macro-header">
            <span class="macro-label" [class.meta-atingida]="carboidratosConsumidos >= carboidratosMeta && carboidratosMeta > 0">Carboidratos</span>
            <span class="macro-valor" [class.meta-atingida]="carboidratosConsumidos >= carboidratosMeta && carboidratosMeta > 0">{{ carboidratosMeta }}g</span>
          </div>
          <div class="macro-progress-wrapper">
            <div class="macro-progress-bar-container">
              <div 
                class="macro-progress-bar macro-progress-carboidratos" 
                [style.width.%]="calcularPercentual(carboidratosConsumidos, carboidratosMeta)">
              </div>
            </div>
            <span class="macro-progress-text" [class.meta-atingida]="carboidratosConsumidos >= carboidratosMeta && carboidratosMeta > 0">{{ carboidratosConsumidos | number:'1.0-0' }}g / {{ carboidratosMeta }}g</span>
          </div>
          <div class="meta-atingida-alert" *ngIf="carboidratosConsumidos >= carboidratosMeta && carboidratosMeta > 0">
            âœ… Meta de carboidratos atingida!
          </div>
        </div>

        <div class="macro-item">
          <div class="macro-header">
            <span class="macro-label" [class.meta-atingida]="gordurasConsumidas >= gordurasMeta && gordurasMeta > 0">Gorduras</span>
            <span class="macro-valor" [class.meta-atingida]="gordurasConsumidas >= gordurasMeta && gordurasMeta > 0">{{ gordurasMeta }}g</span>
          </div>
          <div class="macro-progress-wrapper">
            <div class="macro-progress-bar-container">
              <div 
                class="macro-progress-bar macro-progress-gorduras" 
                [style.width.%]="calcularPercentual(gordurasConsumidas, gordurasMeta)">
              </div>
            </div>
            <span class="macro-progress-text" [class.meta-atingida]="gordurasConsumidas >= gordurasMeta && gordurasMeta > 0">{{ gordurasConsumidas | number:'1.0-0' }}g / {{ gordurasMeta }}g</span>
          </div>
          <div class="meta-atingida-alert" *ngIf="gordurasConsumidas >= gordurasMeta && gordurasMeta > 0">
            âœ… Meta de gorduras atingida!
          </div>
        </div>
      </div>
    </div>

    <div class="card progresso-card">
      <h3>Progresso de Hoje (Macros Consumidos)</h3>
      
      <div *ngIf="hasConsumedData; else noDataPlaceholder">
        <div class="chart-wrapper">
          <ngx-charts-pie-chart
            [results]="dadosDoGrafico"
            [customColors]="colorScheme"
            [doughnut]="true"
            [legend]="false"
            [labels]="true">
          </ngx-charts-pie-chart>
        </div>
        
        <div class="custom-legend">
          <div class="legend-item" *ngFor="let item of dadosDoGrafico">
            <span class="legend-color" [style.background-color]="getCorMacro(item.name)"></span>
            <span class="legend-text">{{ item.name }}: {{ item.value | number:'1.0-0' }}g</span>
          </div>
        </div>
      </div>

      <ng-template #noDataPlaceholder>
        <div class="placeholder-container">
          <p>Registre sua primeira refeiÃ§Ã£o para ver o progresso do seu dia!</p>
        </div>
      </ng-template>
    </div>

    <div class="card chat-card">
      <div class="chat-header">
        <h3>Registre sua RefeiÃ§Ã£o</h3>
        <div class="chat-actions">
          <button 
            type="button" 
            class="btn-icon" 
            (click)="toggleHistoricoChat()"
            title="Ver histÃ³rico">
            ğŸ“…
          </button>
          <button 
            type="button" 
            class="btn-icon" 
            (click)="toggleChatIA()"
            title="SugestÃµes da IA">
            ğŸ¤–
          </button>
          <button 
            type="button" 
            class="btn-icon" 
            (click)="limparConversa()"
            title="Limpar conversa">
            ğŸ—‘ï¸
          </button>
        </div>
      </div>
      
      <p class="chat-description">Descreva o que vocÃª comeu. Ex: "almoÃ§o, 200g de arroz, 150g de frango e salada".</p>
    
      <div class="historico-modal" *ngIf="mostrarHistorico">
        <div class="historico-overlay" (click)="toggleHistoricoChat()"></div>
        <div class="historico-content">
          <div class="historico-header">
            <h4>HistÃ³rico de Conversas</h4>
            <button type="button" class="btn-close" (click)="toggleHistoricoChat()">âœ•</button>
          </div>
          
          <div class="historico-body">
            <div *ngIf="historicoConversas.length === 0" class="historico-vazio">
              <p>Nenhum histÃ³rico encontrado</p>
            </div>
            
            <div 
              *ngFor="let hist of historicoConversas" 
              class="historico-item"
              (click)="carregarHistoricoDia(hist.data)">
              <div class="historico-data">
                {{ formatarDataHistorico(hist.data) }}
              </div>
              <div class="historico-preview">
                {{ hist.mensagens.length }} mensagens
              </div>
              <div class="historico-actions">
                <button 
                  type="button" 
                  class="btn-carregar"
                  (click)="carregarHistoricoDia(hist.data); $event.stopPropagation()">
                  Carregar
                </button>
                <button 
                  type="button" 
                  class="btn-deletar"
                  (click)="deletarHistoricoDia(hist.data); $event.stopPropagation()">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="chat-ia-modal" [class.visible]="mostrarChatIA">
        <div class="historico-overlay" (click)="toggleChatIA()"></div>
        <div class="chat-ia-content">
          <div class="chat-ia-header">
            <h4>ğŸ’¬ SugestÃµes da IA Nutricional</h4>
            <div class="chat-ia-header-actions">
              <button 
                type="button" 
                class="btn-limpar-ia" 
                (click)="limparChatIA()"
                title="Limpar conversa">
                ğŸ—‘ï¸
              </button>
              <button type="button" class="btn-close" (click)="toggleChatIA()">âœ•</button>
            </div>
          </div>
          
          <div class="chat-ia-window">
            <div *ngFor="let mensagem of mensagensChatIA" 
                [ngClass]="mensagem.tipo === 'usuario' ? 'user-message-ia' : 'ia-message'">
              <div class="message-content">{{ mensagem.texto }}</div>
              <div class="message-time">{{ mensagem.timestamp | date:'HH:mm' }}</div>
            </div>
            
            <div *ngIf="aguardandoRespostaIA" class="ia-message typing-indicator">
              <div class="message-content">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
              </div>
            </div>
          </div>

          <form class="chat-ia-input-form" (submit)="enviarMensagemIA($event)">
            <input 
              type="text" 
              name="chatIAInput" 
              placeholder="Digite sua pergunta sobre nutriÃ§Ã£o..." 
              autocomplete="off"
              [disabled]="aguardandoRespostaIA">
            <button type="submit" [disabled]="aguardandoRespostaIA">
              {{ aguardandoRespostaIA ? 'Enviando...' : 'Enviar' }}
            </button>
          </form>
        </div>
      </div>
      
      <div class="chat-window">
        <div *ngFor="let mensagem of mensagensChat" 
            [ngClass]="mensagem.tipo === 'usuario' ? 'user-message' : 'gemini-message'">
          <div class="message-content">{{ mensagem.texto }}</div>
          <div class="message-footer">
            <div class="message-time">{{ mensagem.timestamp | date:'HH:mm' }}</div>
            <div class="message-actions" *ngIf="mensagem.podEditar && mensagem.tipo === 'ia'">
              <button 
                class="btn-editar"
                (click)="iniciarEdicaoRefeicao(mensagem)"
                title="Editar refeiÃ§Ã£o">
                âœï¸
              </button>
              <button 
                class="btn-excluir"
                (click)="excluirRefeicao(mensagem)"
                title="Excluir refeiÃ§Ã£o">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        </div>
        
        <div *ngIf="aguardandoResposta" class="gemini-message typing-indicator">
          <div class="message-content">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
        </div>
      </div>

      <div class="editing-banner" *ngIf="mensagemEditando">
        <span class="editing-text">âœï¸ Editando refeiÃ§Ã£o</span>
        <button class="btn-cancelar-edicao" (click)="cancelarEdicao()">âœ• Cancelar</button>
      </div>

      <form class="chat-input-form" (submit)="enviarMensagemChat($event)">
        <input 
          #chatInput
          type="text" 
          name="chatInput" 
          placeholder="Digite sua refeiÃ§Ã£o aqui..." 
          autocomplete="off"
          [disabled]="aguardandoResposta">
        <button type="submit" [disabled]="aguardandoResposta">
          {{ aguardandoResposta ? 'Enviando...' : (mensagemEditando ? 'Atualizar' : 'Enviar') }}
        </button>
      </form>
    </div>
  </main>
</div>

<div class="modal-overlay" [class.visible]="mostrarConfirmacao">
  <div class="modal-content">
    <h3>{{ tituloConfirmacao }}</h3>
    <p>{{ mensagemConfirmacao }}</p>
    <div class="modal-buttons">
      <button class="btn-cancelar" (click)="cancelarConfirmacao()">Cancelar</button>
      <button class="btn-confirmar" (click)="confirmarAcao()">Sim, confirmar</button>
    </div>
  </div>
</div>